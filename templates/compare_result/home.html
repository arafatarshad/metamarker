
{% extends "dashboard_main_template/dashboard_main.html" %}
{% load staticfiles %}

{% block content %}


<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.9.4/cytoscape.min.js"></script> -->
<script type="text/javascript" src="{% static 'js/cytoscape.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="{% static 'js/excellentexport.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/select2.css/' %}">

<style media="screen">

body {
  font-family: 'Open Sans', sans-serif;
  font-weight: 300;
}
 

.wrap1{
  display:relative !important;

  border: 5px solid #ddd;
 width:100%;
 height:1000px;
}

.wrap:after{
  display:table;
  clear:both;
}
 
.modal-dialog{
   width: 100%;
    overflow-y: initial !important
}
.modal-body{
    height: 450px;
    width:100%;
    overflow-y: auto;
}
path { 
    stroke: steelblue;
    stroke-width: 2;
    fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}
#panel_3_svg_container{
  overflow: scroll;
}

.title-text {
  font-size: 12px;
}
</style>


 

<div class="box box-default">
  <div class="box-header with-border">
    <h3 class="box-title">Step 1</h3>
    <div class="box-tools pull-right">
      <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
    </div>
  </div>
  <div class="box-body">
  	<form name="panel_1_form" id="panel_1_form" action="{% url 'generate_panel_2' %}">
  		  	    <div hidden class="col-md-12 alert alert-info" id="selcetion_alert" role="alert">
           Select job for both the form.
		</div>  
    <div class="row">

      <div class="col-md-4">
        <div class="form-group">
            <label>Select The First job</label>
            <select class="form-control select2" style="width: 100%;" name="job1_select" id="job1_select"> 
            	{% for job in jobs %}
            		<option value={{job.id}}>{{job.name}}</option> 
				{% endfor %}
            </select>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
            <label>Select The First job</label>
            <select class="form-control select2" style="width: 100%;" name="job2_select" id="job2_select"> 
            	            	{% for job in jobs %}
            		<option value={{job.id}}>{{job.name}}</option> 
				{% endfor %}

            </select>
        </div>
      </div>

      <div class="col-md-2">
        <div class="form-group">
            <label>Confirm</label>
            <button type="button" name="confirm" id="confirm" class="btn btn-success form-control" style="width: 100%;" onclick="generate_panel_2()">Submit</button>
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
            <label>Reset</label>
            <button type="button" name="reset" id="reset" class="btn btn-danger form-control" style="width: 100%;" onclick="all_panel_reset()">Reset</button>
        </div>
      </div>

    </div>

  	</form> 
  </div>
</div>

 
 <div class="box box-default">
  <div class="box-header with-border">
    <h3 class="box-title">Step 2</h3>
    <div class="box-tools pull-right">
      <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
    </div>
  </div> 
  <form id="panel_2_job_form" action="{% url 'generate_panel_3' %}"> </form>
</div>





 <div class="box box-default">
  <div class="box-header with-border">
    <h3 class="box-title">Result</h3>
    <div class="box-tools pull-right">
      <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
    </div>
  </div> 
   <div class="box-body" id="panel_3_selection_container"></div> 
   <div class="box-body" id="panel_3_svg_container"></div> 
</div>




{% endblock%}

{%block scripts %}
<script src="{% static 'js/select2.js' %}"></script>
<script type="text/javascript">

   $( document ).ready(function(){
      $('li#compare_result').addClass("active");

      $("#job1_select").select2({
          placeholder: "Select a feature from the list",
          allowClear: true
      }); 
    $("#job2_select").select2({
          placeholder: "Select a feature from the list",
          allowClear: true
      });    
 });

  var job_1_parsed_data=[]
  var job_2_parsed_data=[]
  var final_parsed_data=[]

  var keys_1=[]
  var keys_2=[]

  var job1=null;
  var job2=null;
  var job1_param=null;
  var job2_param=null;  
  var svg=null;
function render_panel_2(data){
	$("#panel_2_job_form").html(data);
}
function all_panel_reset(){
  $('#job1_select').val(null).trigger('change');
  $('#job2_select').val(null).trigger('change');
  $("#panel_2_job_form").html("");
  d3.Select("svg").remove();
  svg=null;
  $("#panel_3_selection_container").empty();
  $("#panel_3_svg_container").empty();
  
}
function go_to_third_panel(){
	job1=$('#job1_select').val();
  job2=$('#job2_select').val();
  job1_param=$('#job1_param').val();
  job2_param=$('#job2_param').val();  

  data={job1:job1,job2:job2,job1_param:job1_param,job2_param:job2_param};

  if($('#job_tracker_1').val()==3){ 
    data.job1_type_param=$('#pls_result_type_1').val();    
  }
	if($('#job_tracker_2').val()==3){ 
    data.job2_type_param=$('#pls_result_type_2').val();
  }
	
	if((job1==null) || (job2==null)){ 
 		$('#selcetion_alert').fadeIn(1000).fadeOut(3000);
	}else{ 
		var token = '{{csrf_token}}';
		$.ajax({
			headers: { "X-CSRFToken": token },
			type: "POST",
            url: $("#panel_2_job_form").attr('action'), 
            data: data,
            success: function (data) {  
               parse_data_for_chart(data);
            },
            error: function (e) {
             alert('Error');
            }
        });	
	}	
}


function parse_data_for_chart(data){
  job_1_parsed_data=[]
  job_2_parsed_data=[]
  final_parsed_data=[]
  
  keys_1=[]
  keys_2=[]
  
  parse_helper(1,data.job1);
  parse_helper(2,data.job2);

  // console.log(job_1_parsed_data);
  // console.log(job_2_parsed_data);
  
  draw_the_chart();
}

function parse_helper(selecter,values){
    if(selecter==1){
      if($('#job_tracker_1').val()==1)
        parse_pca_job_data(1,values)
      else if($('#job_tracker_1').val()==2) 
        parse_dca_job_data(1,values)
      else 
        parse_pls_job_data(1,values)
    }else{
      if($('#job_tracker_2').val()==1)
        parse_pca_job_data(2,values)
      else if($('#job_tracker_2').val()==2) 
        parse_dca_job_data(2,values)
      else 
        parse_pls_job_data(2,values)
    } 
}

function parse_pca_job_data(selector,values){
  values=JSON.parse(values);
  for(var i in values){
    
    if(selector==1){
      keys_1.push(i);
      job_1_parsed_data.push(values[i]);
    }
    else{ 
      keys_2.push(i);
      job_2_parsed_data.push(values[i]);
    }
  }  
}

function parse_pls_job_data(selector,values){
  values=JSON.parse(values);
  for(var i in values){ 
    if(selector==1){
      keys_1.push(values[i].id);
      job_1_parsed_data.push(values[i].value);
    }
    else{ 
      keys_2.push(values[i].id);
      job_2_parsed_data.push(values[i].value);
    }
  }  
}

function parse_dca_job_data(selector,values){  
  // console.log(values);
    var cy = cytoscape({
    elements:JSON.parse(values),
  }); 
    if(selector==1){
      if (job1_param=="degree_centrality") {
        parse_dca_degree(selector,cy,values);
      }
      else if (job1_param=="page-rank_centrality") {
        parse_dca_pagerank(selector,cy,values);
      }
      else if (job1_param=="betweenness_centrality") {
        parse_dca_betweenness(selector,cy,values);
      }
      else{
        parse_dca_closeness(selector,cy,values);
      }
    }
    else{ 
      if (job2_param=="degree_centrality") {
        parse_dca_degree(selector,cy,values);
      }
      else if (job2_param=="page-rank_centrality") {
        parse_dca_pagerank(selector,cy,values);
      }
      else if (job2_param=="betweenness_centrality") {
        parse_dca_betweenness(selector,cy,values);
      }
      else{
        parse_dca_closeness(selector,cy,values);
      }
    } 
}


function parse_dca_degree(selector,cy,values){  
 var dcn = cy.$().dcn();
  
    
    if (selector==1) {
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_1.push(item.id());
        try {

          var centrality= dcn.degree('#'+item.id());  
          if(isNaN(centrality)){ 
             job_1_parsed_data.push(0); 
          }
          else{
            job_1_parsed_data.push(centrality);
          }
        
        }
        catch(err) {
             job_1_parsed_data.push(0);
        }
        
      }         
      });
    }else{
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_2.push(item.id());
        try { 
            var centrality= dcn.degree('#'+item.id());

          if(isNaN(centrality))
            job_2_parsed_data.push(0);
          else 
            job_2_parsed_data.push(centrality);
        }
        catch(err) {
             job_2_parsed_data.push(0);
        }
        
      }         
      });
    } 
    // console.log(job_2_parsed_data)
}
function parse_dca_closeness(selector,cy,values){  
  var ccn = cy.$().ccn();   
    if (selector==1) {
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_1.push(item.id());
        try { 

          var centrality= ccn.closeness('#'+item.id());  
          if(isNaN(centrality)){ 
            job_1_parsed_data.push(0); 
          }
          else{
            job_1_parsed_data.push(centrality);
          }

        }
        catch(err) {
            job_2_parsed_data.push(0);
        }
        
      }         
      });
    }else{
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_2.push(item.id());
        try {


          // job_2_parsed_data.push(ccn.closeness('#'+item.id()));
          var centrality= ccn.closeness('#'+item.id());  
          if(isNaN(centrality)){ 
            job_2_parsed_data.push(0); 
          }
          else{
            job_2_parsed_data.push(centrality);
          }

        }
        catch(err) {
            job_2_parsed_data.push(0);
        }
        
      }         
      });
    } 
}
function parse_dca_betweenness(selector,cy,values){  
 var bc = cy.$().bc(); 
 if (selector==1) {
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_1.push(item.id());
        try {

            // job_1_parsed_data.push(bc.betweenness('#'+item.id()));
          var centrality= bc.betweenness('#'+item.id());  
          if(isNaN(centrality)){ 
            job_1_parsed_data.push(0); 
          }
          else{
            job_1_parsed_data.push(centrality);
          }



        }
        catch(err) {
            job_1_parsed_data.push(0);
        }
        
      }         
      });
    }else{
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_2.push(item.id());
        try {
            // job_2_parsed_data.push(bc.betweenness('#'+item.id()));
                        // job_1_parsed_data.push(bc.betweenness('#'+item.id()));
          var centrality= bc.betweenness('#'+item.id());  
          if(isNaN(centrality)){ 
            job_2_parsed_data.push(0); 
          }
          else{
            job_2_parsed_data.push(centrality);
          }
        }
        catch(err) {
            job_2_parsed_data.push(0);
        }
        
      }         
      });
    } 
}
function parse_dca_pagerank(selector,cy,values){  
   var pr = cy.elements().pageRank(); 
    if (selector==1) {
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_1.push(item.id());
        try {
            // job_1_parsed_data.push(pr.rank('#'+item.id()));
                        // job_1_parsed_data.push(bc.betweenness('#'+item.id()));
          var centrality= pr.rank('#'+item.id());  
          if(isNaN(centrality)){ 
            job_1_parsed_data.push(0); 
          }
          else{
            job_1_parsed_data.push(centrality);
          }
        }
        catch(err) {
            job_1_parsed_data.push(0);
        }
        
      }         
      });
    }else{
      cy.elements().forEach(function(item,index){
        if(item.isNode()){ 
        keys_2.push(item.id());
        try {
            // job_2_parsed_data.push(pr.rank('#'+item.id()));
          var centrality= pr.rank('#'+item.id());  
          if(isNaN(centrality)){ 
            job_2_parsed_data.push(0); 
          }
          else{
            job_2_parsed_data.push(centrality);
          }
        }
        catch(err) {
            job_2_parsed_data.push(0);
        }
        
      }         
      });
    } 
}


function generate_panel_2(){
 	var job1=$('#job1_select').val();
	var job2=$('#job2_select').val();

	if((job1==null) || (job2==null)){ 
 		$('#selcetion_alert').fadeIn(1000).fadeOut(3000);
	}else{

		var token = '{{csrf_token}}';
		$.ajax({
			headers: { "X-CSRFToken": token },
			type: "POST",
            url: $("#panel_1_form").attr('action'), 
            data: $("#panel_1_form").serialize(),
            success: function (data) {
               render_panel_2(data); 
            },
            error: function (e) {
             alert('Error');
            }
        });		
	}
}		


function fomrmat_single_dataset(){
  keys_1.forEach(function(d,i){ 
    var key2=keys_2.indexOf(d)
    if(key2 !=-1){ 
      final_parsed_data.push({id:d,value1:job_1_parsed_data[i],value2:job_2_parsed_data[key2]})
    }
  }); 
}

function addSelectBar(){
  $('#panel_3_selection_container').html('')
  $('#panel_3_selection_container').html('<div class="col-md-9"><select class="form-control" id="scale_selector"><option value="0">Regular Scale</option><option value="1">Reverse Scale</option></select></div><div class="col-md-3"><button class="form-control btn-info" onclick=render_the_chart()>Render</button></div>')
}
function draw_the_chart(){

  fomrmat_single_dataset();
  addSelectBar();
  render_the_chart();
}

function sortByProperty(property){  
   return function(a,b){  
      if(a[property] < b[property])  
         return 1;  
      else if(a[property] > b[property])  
         return -1;  
  
      return 0;  
   }  
}
 


function render_the_chart(){
  $("#panel_3_svg_container").html(''); 
  // ;
  // svg.selectAll().remove();

  // var margin = {top: 30, right: 40, bottom: 90, left: 50},width = 9000 - margin.left - margin.right,height = 770 - margin.top - margin.bottom;
  // var margin = {top: 30, right: 40, bottom: 90, left: 50}
  // ,width = 5000 - margin.left - margin.right,height = 770 - margin.top - margin.bottom;


  if($('#scale_selector').val()==1)
     final_parsed_data.sort(sortByProperty("value2"));
  else

     final_parsed_data.sort(sortByProperty("value1"));
     
  // if($('#scale_selector').val()==1){
  //   final_parsed_data.sort(function(obj1, obj2) {
  //     // console.log(obj1.id+"-------------"+obj2.id+"==="+(obj1.value2 - obj2.value2));
  //     return obj2.value2 - obj1.value2;
  //   });
  // }
  // else{
  //   final_parsed_data.sort(function(obj1, obj2) {
  //     return obj2.value1 - obj1.value1;
  //   });
  // }

  console.log(final_parsed_data);

  keys_temp=[];
  final_parsed_data.forEach(function(d){keys_temp.push(d.id);});
  


  var margin = {top: 30, right: 40, bottom: 90, left: 50},width = (keys_temp.length*22) - margin.left - margin.right,height = 770 - margin.top - margin.bottom;
  // var margin = {top: 30, right: 40, bottom: 30, left: 50},width = $('#panel_3_svg_container').width() - margin.left - margin.right,height = $('#panel_3_svg_container').height() - margin.top - margin.bottom;
  svg = d3.select("#panel_3_svg_container").append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top +margin.bottom).append("g")
  .attr("transform","translate(" + margin.left + "," + margin.top + ")");

  svg.selectAll("path").remove();



  // var x = d3.scaleBand().domain(d3.extent(final_parsed_data, function(d) { console.log(d); return d.id })).range([0, width]);
  // var x = d3.scaleBand().domain(d3.extent(final_parsed_data, function(d) { consol;e.return d.id })).range([0, width]).paddingInner(0.3).paddingOuter(0.1);
      // x.domain(d3.extent(final_parsed_data,function(d){console.log(d.id);return d.id;});
  

  // console.log(keys_temp);
  


  var x = d3.scaleBand().domain(keys_temp).range([0, width]);
  var xAxis = d3.axisBottom().scale(x).tickFormat(function(d,i) { return  d; });
  svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + height + ")").call(xAxis).selectAll("text").style("text-anchor", "end")
  .attr("dx", "-.8em").attr("dy", ".15em").attr("transform", function(d) {return "rotate(-65)" });

  // var y0 = d3.scaleLinear().domain([d3.min(value1), d3.max(value1)]).range([height,0]); 
  var y0 = d3.scaleLinear().domain([d3.min(final_parsed_data, function(d) {return Math.min(d.value1);}), d3.max(final_parsed_data, function(d) {return Math.max(d.value1);})]).range([height,0]); 
  




  if($('#scale_selector').val()==1)
    var y1 = d3.scaleLinear().domain([d3.min(final_parsed_data, function(d) {return Math.min(d.value2);}), d3.max(final_parsed_data, function(d) {return Math.max(d.value2);})]).range([0,height]);
  else
    var y1 = d3.scaleLinear().domain([d3.min(final_parsed_data, function(d) {return Math.min(d.value2);}), d3.max(final_parsed_data, function(d) {return Math.max(d.value2);})]).range([height,0]);
  // var y1 = d3.scaleLinear().domain([d3.min(value2), d3.max(value2)]).range([0,height]);

  var yAxisLeft = d3.axisLeft().scale(y0).ticks(10);
  var yAxisRight = d3.axisRight().scale(y1).ticks(10);

  var valueline = d3.line().x(function(d) {return x(d.id); }).y(function(d) {return y0(d.value1); })
  
  var valueline2 = d3.line().x(function(d) { return x(d.id);}).y(function(d) {return y1(d.value2); });
// svg.append("path").style("stroke", "blue").attr("d", valueline(dataset));
  svg.append("path").style("stroke", "red").attr("d", valueline2(final_parsed_data));
  // .on("mouseover", function(d, i) {
  //       console.log("mous over");

  //     svg.append("text")
  //       .attr("class", "title-text")
  //       .style("fill", "red")        
  //       .text(d.value2)
  //       .attr("text-anchor", "middle")
  //       .attr("x", (width-margin)/2)
  //       .attr("y", 150);
  //   })
  // .on("mouseout", function(d) {
  //     svg.select(".title-text").remove();
  //   });



  svg.append("g").attr("class", "y axis").style("fill", "steelblue").call(yAxisLeft)
    .append("text").attr("transform", "rotate(-90)").attr("y", 6).attr("dy", ".71em").style("text-anchor", "end").text($("#job1_select option:selected").html());

  svg.append("g").attr("class", "y axis").attr("transform", "translate(" + width + " ,0)").style("fill", "red").call(yAxisRight)
      .append("text").attr("transform", "rotate(0)").attr("y", 6).attr("dy", ".71em").style("text-anchor", "end").text($("#job2_select option:selected").html());


  svg.append("path").style("stroke", "steelblue").attr("d", valueline(final_parsed_data));
  svg.append("path").style("stroke", "red").attr("d", valueline2(final_parsed_data));


}


</script>



<script type="text/javascript" src="{% static 'js/result_compare_js_1.js' %}"> </script>
{% endblock%}


